.. sectionauthor:: Роман Гайнуллов <roman.gainullov@nextgis.com>

.. _ngidop:

Общее описание NextGIS ID on-premise
========

В локальных сетях организаций с определенным уровнем изоляции от глобальной сети интернет, требуются функции авторизации пользователей настольного 
и мобильного программного обеспечения (ПО) NextGIS. Для этого необходимо использовать сервер авторизации NextGIS ID on-premise. 
Данный сервер предоставляет следующие возможности:

* ввод пользователя с указанием логина и пароля;
* изменение свойств пользователя (пароль, имя), удаление пользователя;
* добавление пользователя в команду, которой обеспечивается расширенный доступ к функциональности ПО, изменение состава команды;
* веб интерфейс для авторизации пользователя в рамках oAuth2;
* персональная веб страница пользователя с профилем пользователя и возможность изменить пароль входа.

При входе в корень сервиса **/** открывается диалог авторизации пользователя (см. :numref:`auth_window`), в котором необходимо указать логин и пароль пользователя, заведенного в административном интерфейсе.

.. figure:: _static/auth_window.png
   :name: auth_window
   :align: center
   :width: 16cm

   Окно авторизации пользователя

После успешной авторизации, пользователю отображается окно со страницей его профиля (см. :numref:`profile_window`). 
В данном окне пользователь может изменить информацию о себе и пароль входа.
Для получения доступа к расширенным функциям настольного ПО NextGIS QGIS необходимо указать адрес сервера NextGIS ID в настройках настольного ПО (см. :numref:`auth_server_settings`). 
По-умолчанию выставлен публичный сервис авторизации `https://my.nextgis.com <https://my.nextgis.com>`_.

**Примечание:** во внутренней сети сервис может быть развернут по следующему адресу - `https://gis.mycompany.ru/ngid <https://gis.mycompany.ru/ngid>`_. 
Данный путь следует указывать в качестве адреса сервера авторизации. В браузере открывать следующий адрес:
* https://gis.mycompany.ru/ngid/ - профиль пользователя.

.. figure:: _static/profile_window.png
   :name: profile_window
   :align: center
   :width: 16cm

   Окно профиля пользователя
   
.. figure:: _static/auth_server_settings.png
   :name: auth_server_settings
   :align: center
   :width: 16cm

   Настройка сервера авторизации в NextGIS QGIS
 
Механизм управления командой позволяет добавить в свою команду дополнительного пользователя, указав для него логин и пароль, или удалить его из команды. Управление командой доступно через личный кабинет по подпути **/users** в разделе “Команда” (см. :numref:`ngidop_team`). Каждый добавленный пользователь появиится в списке и будет иметь расширенный доступ к функиям ПО NextGIS.

.. figure:: _static/ngidop_team.png
   :name: ngidop_team
   :align: center
   :width: 16cm

   Добавление пользователей в Команду

В разделе *Приложения OAuth* предоставляется доступ для авторизации в различных приложениях NextGIS - NextGIS Formuilder, NextGIS QGIS, NextGIS Web, NextGIS Collector, NextGIS Mobile (см. :numref:`ngidop_apps_oauth`). 

.. figure:: _static/ngidop_apps_oauth.png
   :name: ngidop_apps_oauth
   :align: center
   :width: 16cm

   Настройка OAuth applications

Страница настроек LDAP открывается по подпути **/ldapsettings** (см. :numref:`ldap_settings`).
В блоке LDAP SERVER указывается адрес сервера авторизации, логин/пароль учетной записи пользователя для подключения к серверу.

**Примечание: интеграция с внешним сервером Microsoft Active Directory.** 
При авторизации через стандартный диалог входа NextGIS Web идет проверка существования данного пользователя в ПО NextGIS Web. Если аккаунт пользователя имеет тип Microsoft Active Directory - то проверка пароля осуществляется в Microsoft Active Directory. Если пользователя не существует, то проверяется существование пользователя в сервере Microsoft Active Directory. Если пользователь существует, то проверяется введенный пароль. Если сервер Microsoft Active Directory успешно авторизовал пользователя, то в ПО NextGIS Web создается пользователь с такими же логином и именем и типом аккаунта Microsoft Active Directory.

.. figure:: _static/ldap_settings.png
   :name: ldap_settings
   :align: center
   :width: 16cm

   Страница настроек LDAP
   
В блоке **Поиск пользователя** указывается база, в которой осуществляется поиск пользователя и его LDAP атрибуты, соответствующие искомым параметрам (логин, имя, фамилия).

Если пользователь принадлежит какой-то **группе**, то имеется возможность указать это в последнем блоке настроек конфигурации LDAP. Параметр не является обязательным, но дает возможность ограничивать авторизацию пользователей, не принадлежащих к конкретной группе. Пользователи из других групп не будут иметь возможности авторизоваться даже при указании корректной пары логин/пароль.

Для интеграции с глобальными сервисами NextGIS используется уникальный GUID, указанный в разделе **NextGIS ID on-premise** (см. :numref:`ngidop_guid`). Его необходимо прописать в настройках учетной записи на  `my.nextgis.com <https://my.nextgis.com/myngidonpremises>`_ в разделе NextGIS ID on-premise (см. :numref:`GUID_on_my`).

.. figure:: _static/ngidop_guid.png
   :name: ngidop_guid
   :align: center
   :width: 16cm

   Идентификатор GUID в разделе NextGIS ID on-premise

.. figure:: _static/GUID_on_my.png
   :name: GUID_on_my
   :align: center
   :width: 16cm

   Идентификатор GUID в облачном аккаунте NextGIS ID
